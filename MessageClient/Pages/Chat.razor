@page "/"
@using MessageClient.Models
@inject HttpClient Http
@using System;

<div class="main-message-body">
    <div class="all-message-form">
        @for(int i = messages.Count-1; i >= 0; i--)
        {
            <div>
                <div class="message-form">
                    <div class="message-form-header">
                        <div> 
                            @messages[i].Id
                        </div>
                        <div>
                            @GetTime(messages[i])
                            @* @message.Timestamp.ToLocalTime().ToString("T") *@
                        </div>
                    </div>
                    <div class="message-form-header">
                        <div>
                            @messages[i].Content
                        </div>
                        <div>
                            <MudIcon Icon="@Icons.Material.Filled.BorderColor"
                            Color="Color.Primary"
                            Size="Size.Medium"
                                     @onclick="@(() => SetValueToId(messages[i].Id))"
                            style="cursor: pointer;" />
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="bottom-container">
        <MudTextField @bind-Value="newMessage" Label="Enter your message" Variant="Variant.Filled" />
        <MudButton OnClick="SendMessage" Color="Color.Primary">Send</MudButton>
    </div>
</div>

@code {

    private string? newMessage;
    private List<Message> messages = new();
    private Guid guid;

    protected override async Task OnInitializedAsync()
    {
        guid = Guid.NewGuid();
        messages = await Http.GetFromJsonAsync<List<Message>>("api/Messages");
    }

    private void SetValueToId(Guid id){
        guid = id;
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessage))
        {

            var objecttt = new MessageRequest { Content = newMessage };
            var response = await Http.PutAsJsonAsync($"api/Messages/{guid}", objecttt);

            guid = Guid.NewGuid();

            if (response.IsSuccessStatusCode)
            {

                newMessage = string.Empty;
                messages = await Http.GetFromJsonAsync<List<Message>>("api/Messages");
            }
        }
    }

    private string GetTime(Message message)
    {
        if(message.LastModified is null)
        {
            return message.Timestamp.ToLocalTime().ToString("T");
        }

        var localtime = (DateTimeOffset)(object)message.LastModified;

        return localtime.ToLocalTime().ToString("T");

    }
}
